# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Ruby gem providing a simple wrapper for the HipChat HTTP API v1. The gem includes integrations for Capistrano (deploy notifications), Chef (exception handling), and Rails 3 (rake tasks).

## Common Commands

### Testing
```bash
rake spec      # Run all specs
rake           # Default task runs specs
```

### Gem Management
```bash
rake build     # Build gem into pkg/ directory
rake gemspec   # Regenerate hipchat.gemspec from Jeweler config
rake install   # Build and install gem locally
```

The gemspec is auto-generated by Jeweler - edit Rakefile:6-16 instead of modifying hipchat.gemspec directly.

## Architecture

### Core Structure

The gem follows a two-class pattern:

- **HipChat::Client**: Entry point that holds the API token and provides room access
  - Uses HTTParty to communicate with `https://api.hipchat.com/v1/rooms`
  - `#rooms` returns array of all accessible rooms
  - `#[]` provides direct room access by name/ID without API validation

- **HipChat::Room**: Represents a chat room, inherits from OpenStruct
  - `#send(from, message, options={})` posts messages via HTTP POST
  - Handles response codes: 200 (success), 404 (UnknownRoom), 401 (Unauthorized), other (UnknownResponseCode)
  - Options: `:color` (yellow/red/green/purple/random), `:notify` (boolean for user notifications)

### Integration Modules

**Capistrano** (lib/hipchat/capistrano.rb):
- Automatically hooks into deploy lifecycle via `before`/`after` hooks
- Notifies on deploy start, completion, and rollback
- Derives deploying user from: `$HIPCHAT_USER` env var → `:hipchat_human` capistrano var → `git config user.name` → `$USER`
- Configuration via capistrano variables: `:hipchat_token`, `:hipchat_room_name`, `:hipchat_announce`

**Chef** (lib/hipchat/chef.rb):
- Provides `HipChat::NotifyRoom` exception handler class
- Install by adding to client.rb: `exception_handlers << HipChat::NotifyRoom.new(token, room_name)`
- Sends formatted exception messages on chef-client failures

**Rails 3** (lib/hipchat/rails3_tasks.rb + lib/hipchat/railtie.rb):
- Railtie automatically loads `hipchat:send` rake task in Rails 3+ apps
- Task reads config from `config/hipchat.yml` or ENV vars (MESSAGE, USER, NOTIFY, ROOM, TOKEN)
- Usage: `rake hipchat:send MESSAGE="hello world"`

### Testing Patterns

- RSpec 2.x with RR mocking framework (spec/spec_helper.rb)
- HTTP requests are mocked using `mock(HipChat::Room).post(...)`
- Tests verify request parameters and response code handling
- See spec/hipchat_spec.rb:8-20 for the `mock_successful_send` helper pattern
